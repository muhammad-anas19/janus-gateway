version: "3.8"

services:
  janus-gateway:
    image: canyan/janus-gateway:latest
    container_name: janus-gateway
    restart: unless-stopped
    labels:
        - "traefik.enable=true"
        # Router configuration - HTTPS only
        - "traefik.http.routers.janus-gateway.rule=Host(`janus-gateway.coolify.arcsip.io`)"
        - "traefik.http.routers.janus-gateway.entrypoints=https"
        - "traefik.http.routers.janus-gateway.tls=true"
        - "traefik.http.routers.janus-gateway.tls.certresolver=letsencrypt"
        # Service configuration
        - "traefik.http.services.janus-gateway.loadbalancer.server.port=8188"
        # HTTP to HTTPS redirect
        - "traefik.http.routers.janus-gateway-http.rule=Host(`janus-gateway.coolify.arcsip.io`)"
        - "traefik.http.routers.janus-gateway-http.entrypoints=http"
        - "traefik.http.routers.janus-gateway-http.middlewares=redirect-to-https"
        - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
        - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"

    # Port mappings - CRITICAL: Ensure firewall allows these ports
    ports:
      # WebSocket (proxied through Traefik for WSS)
      - "8188:8188"
      # RTP media ports (UDP) - MUST be open in firewall for audio to work
      - "20000-20100:20000-20100/udp"
      # SIP signaling
      - "5060:5060/udp"
      - "5060:5060/tcp"

    # Mount configuration files
    volumes:
      - ./janus-config:/opt/janus/etc/janus:ro
      - ./certs:/opt/janus/share/janus/certs:ro

    # Environment variables
    environment:
      - JANUS_DEBUG_LEVEL=4

    # Health check

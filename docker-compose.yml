version: "3.8"

services:
  janus-gateway:
    # Build from custom Dockerfile instead of using pre-built image
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PUBLIC_IP: "5.78.103.238"
    image: arcsip-janus-gateway:latest
    container_name: janus-gateway
    restart: unless-stopped
    labels:
        - "traefik.enable=true"
        # Router configuration - HTTPS only
        - "traefik.http.routers.janus-gateway.rule=Host(`janus-gateway.coolify.arcsip.io`)"
        - "traefik.http.routers.janus-gateway.entrypoints=https"
        - "traefik.http.routers.janus-gateway.tls=true"
        - "traefik.http.routers.janus-gateway.tls.certresolver=letsencrypt"
        # Service configuration
        - "traefik.http.services.janus-gateway.loadbalancer.server.port=8188"
        # HTTP to HTTPS redirect
        - "traefik.http.routers.janus-gateway-http.rule=Host(`janus-gateway.coolify.arcsip.io`)"
        - "traefik.http.routers.janus-gateway-http.entrypoints=http"
        - "traefik.http.routers.janus-gateway-http.middlewares=redirect-to-https"
        - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
        - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"

    # Port mappings - CRITICAL: Ensure firewall allows these ports
    ports:
      # WebSocket (proxied through Traefik for WSS)
      - "8188:8188"
      # RTP media ports (UDP) - MUST be open in firewall for audio to work
      - "20000-20100:20000-20100/udp"
      # SIP signaling
      - "5060:5060/udp"
      - "5060:5060/tcp"

    # Environment variables
    environment:
      - JANUS_DEBUG_LEVEL=4
      # CRITICAL: Your server's public IP for NAT traversal
      - NAT_PUBLIC_IP=5.78.103.238

    # Optional: Mount certs if using WSS directly (not through Traefik)
    volumes:
      - ./certs:/opt/janus/share/janus/certs:ro

    # Health check
